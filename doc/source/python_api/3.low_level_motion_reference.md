---
title: 底层运动控制服务
createTime: 2025/01/27 15:30:00
permalink: /dog/python_low_level_motion_reference/
---
# 底层运动控制服务 (Python)

> 提供机器人系统底层运动控制服务，通过 LowLevelMotionController 可以使用话题通信方式实现对机器人关节的指令控制和状态获取。

> ⚠️ **<font color="red">注意事项：调用 publish_leg_command 接口，用户命令才会下发到运控，因此需要用户保证调用 publish_leg_command 的频率，建议是 500 hz。</font>**

## 接口定义

<code>LowLevelMotionController</code> 是面向底层开发的运动控制器，支持对腿等运动部件的直接控制与状态订阅。

### <code>LowLevelMotionController</code> — 低级运动控制器

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>类名</td><td><code>LowLevelMotionController</code></td></tr>
    <tr><td>功能概述</td><td>底层关节级运动控制器，提供精确的关节控制</td></tr>
    <tr><td>主要功能</td><td>关节状态订阅、关节命令发布、控制周期设置</td></tr>
    <tr><td>使用场景</td><td>精确运动控制、自定义步态、研究开发</td></tr>
  </tbody>
</table>

### initialize
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>方法名</td><td><code>initialize</code></td></tr>
    <tr><td>方法声明</td><td><code>bool initialize()</code></td></tr>
    <tr><td>功能概述</td><td>初始化控制器，建立底层连接。</td></tr>
    <tr><td>返回值</td><td><code>true</code> 表示成功，<code>false</code> 表示失败。</td></tr>
    <tr><td>备注</td><td>首次调用必须初始化。</td></tr>
  </tbody>
</table>

### shutdown
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>方法名</td><td><code>shutdown</code></td></tr>
    <tr><td>方法声明</td><td><code>void shutdown()</code></td></tr>
    <tr><td>功能概述</td><td>关闭控制器，释放底层资源。</td></tr>
    <tr><td>备注</td><td>配合 initialize 使用。</td></tr>
  </tbody>
</table>

### subscribe_leg_state
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>方法名</td><td><code>subscribe_leg_state</code></td></tr>
    <tr><td>方法声明</td><td><code>void subscribe_leg_state(callback)</code></td></tr>
    <tr><td>功能概述</td><td>订阅下肢关节状态数据。</td></tr>
    <tr><td>参数说明</td><td><code>callback</code>：回调函数，用于处理下肢关节状态的接收数据。函数签名：callback(data : LegState) -> None</td></tr>
    <tr><td>备注</td><td>非阻塞接口。</td></tr>
  </tbody>
</table>

### publish_leg_command
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>方法名</td><td><code>publish_leg_command</code></td></tr>
    <tr><td>方法声明</td><td><code>Status publish_leg_command(LegJointCommand command)</code></td></tr>
    <tr><td>功能概述</td><td>发布下肢关节控制指令。</td></tr>
    <tr><td>参数说明</td><td><code>command</code>：包含目标角度/速度等控制信息的下肢关节控制指令。</td></tr>
    <tr><td>返回值</td><td><code>Status::OK</code> 表示成功，其他为失败。</td></tr>
    <tr><td>备注</td><td>非阻塞接口。</td></tr>
  </tbody>
</table>

### enable_send_msg
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>方法名</td><td><code>enable_send_msg</code></td></tr>
    <tr><td>方法声明</td><td><code>Status enable_send_msg(bool enable)</code></td></tr>
    <tr><td>功能概述</td><td>LCM 通道开关。</td></tr>
    <tr><td>参数说明</td><td><code>enable</code>：LCM 通道开关信息。</td></tr>
    <tr><td>返回值</td><td><code>Status::OK</code> 表示成功，其他为失败。</td></tr>
    <tr><td>备注</td><td>使用高层运动控制时，关闭 LCM 通道，使用底层运动控制时，打开 LCM 通道。</td></tr>
  </tbody>
</table>


## 数据结构定义

### <code>LegJointCommandArray</code> — 腿部关节命令数组

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>类型</td><td><code>std::array&lt;magic::dog::SingleLegJointCommand, magic::dog::kLegJointNum&gt;</code> 的 Python 绑定</td></tr>
    <tr><td>功能概述</td><td>固定大小的腿部关节命令数组，包含所有腿部关节的控制指令</td></tr>
    <tr><td>主要方法</td><td>支持索引访问、迭代、长度查询，长度固定为腿部关节数量</td></tr>
    <tr><td>使用场景</td><td>腿部运动控制、关节协调控制、步态规划</td></tr>
  </tbody>
</table>

### <code>LegJointStateArray</code> — 腿部关节状态数组

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>类型</td><td><code>std::array&lt;magic::dog::SingleLegJointState, magic::dog::kLegJointNum&gt;</code> 的 Python 绑定</td></tr>
    <tr><td>功能概述</td><td>固定大小的腿部关节状态数组，包含所有腿部关节的实时状态信息</td></tr>
    <tr><td>主要方法</td><td>支持索引访问、迭代、长度查询，长度固定为腿部关节数量</td></tr>
    <tr><td>使用场景</td><td>关节状态监控、运动反馈、安全检测</td></tr>
  </tbody>
</table>

### <code>SingleLegJointCommand</code> — 单腿关节命令结构体

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>q_des</code></td><td><code>float</code></td><td>期望关节角度</td></tr>
    <tr><td><code>dq_des</code></td><td><code>float</code></td><td>期望关节角速度</td></tr>
    <tr><td><code>tau_des</code></td><td><code>float</code></td><td>期望关节力矩</td></tr>
    <tr><td><code>kp</code></td><td><code>float</code></td><td>位置增益</td></tr>
    <tr><td><code>kd</code></td><td><code>float</code></td><td>速度增益</td></tr>
  </tbody>
</table>

### <code>LegJointCommand</code> — 腿部关节命令结构体

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>timestamp</code></td><td><code>int</code></td><td>时间戳</td></tr>
    <tr><td><code>cmd</code></td><td><code>LegJointCommandArray</code></td><td>关节命令列表</td></tr>
  </tbody>
</table>

### <code>SingleLegJointState</code> — 单腿关节状态结构体

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>q</code></td><td><code>float</code></td><td>关节角度</td></tr>
    <tr><td><code>dq</code></td><td><code>float</code></td><td>关节角速度</td></tr>
    <tr><td><code>tau_est</code></td><td><code>float</code></td><td>估计关节力矩</td></tr>
  </tbody>
</table>

### <code>LegState</code> — 腿部状态结构体

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>timestamp</code></td><td><code>int</code></td><td>时间戳</td></tr>
    <tr><td><code>state</code></td><td><code>LegJointStateArray</code></td><td>关节状态列表</td></tr>
  </tbody>
</table>

## URDF 参考

[机器人 URDF](https://github.com/MagiclabRobotics/magicdog_description)


## 底层运动控制机器人状态介绍

机器人底层运动主要是开发关节的三环控制给开发人员进行机器人运动能力的二次开发，基本的控制状态切换机制：

![状态切换示意图](../image/dog/low_level_ctrl_state.png)

## 注意事项

在使用 Subscribe 等订阅类 SDK 接口时，请避免在回调函数中执行阻塞式的数据处理操作。否则，可能导致消息堆积、处理延迟，甚至引发不可预期的错误。