---
title: 底层运动控制服务
createTime: 2025/05/29 10:18:56
permalink: /dog/low_level_motion_reference/
---
# MagicDog SDK C++ API - 底层运动控制服务

> 提供机器人系统底层运动控制服务，通过 LowLevelMotionController 可以使用话题通信方式实现对机器人关节的指令控制和状态获取。

> ⚠️ **<font color="red">注意事项：调用 PublishLegCommand 接口，用户命令才会下发到运控，因此需要用户保证调用 PublishLegCommand 的频率，建议是 500 hz。</font>**

## 接口定义
<code>LowLevelMotionController</code> 是面向底层开发的运动控制器，支持对腿等运动部件的直接控制与状态订阅。

### LowLevelMotionController
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>LowLevelMotionController</td></tr>
    <tr><td>函数声明</td><td><code>LowLevelMotionController();</code></td></tr>
    <tr><td>功能概述</td><td>构造函数，初始化低层控制器对象。</td></tr>
    <tr><td>备注</td><td>构造内部资源。</td></tr>
  </tbody>
</table>

### ~LowLevelMotionController
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>~LowLevelMotionController</td></tr>
    <tr><td>函数声明</td><td><code>virtual ~LowLevelMotionController();</code></td></tr>
    <tr><td>功能概述</td><td>析构函数，释放资源。</td></tr>
    <tr><td>备注</td><td>清理底层资源。</td></tr>
  </tbody>
</table>

### Initialize
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>Initialize</td></tr>
    <tr><td>函数声明</td><td><code>virtual bool Initialize() override;</code></td></tr>
    <tr><td>功能概述</td><td>初始化控制器，建立底层连接。</td></tr>
    <tr><td>返回值</td><td><code>true</code> 表示成功，<code>false</code> 表示失败。</td></tr>
    <tr><td>备注</td><td>首次调用必须初始化。</td></tr>
  </tbody>
</table>

### Shutdown
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>Shutdown</td></tr>
    <tr><td>函数声明</td><td><code>virtual void Shutdown() override;</code></td></tr>
    <tr><td>功能概述</td><td>关闭控制器，释放底层资源。</td></tr>
    <tr><td>备注</td><td>配合 Initialize 使用。</td></tr>
  </tbody>
</table>

### SubscribeLegState
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>SubscribeLegState</td></tr>
    <tr><td>函数声明</td><td><code>void SubscribeLegState(LegJointStateCallback callback);</code></td></tr>
    <tr><td>功能概述</td><td>订阅下肢关节状态数据</td></tr>
    <tr><td>参数说明</td><td>callback：回调函数，用于处理下肢关节状态的接收数据</td></tr>
    <tr><td>备注</td><td>非阻塞接口。</td></tr>
  </tbody>
</table>

### PublishLegCommand
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>PublishLegCommand</td></tr>
    <tr><td>函数声明</td><td><code>Status PublishLegCommand(const LegJointCommand& command);</code></td></tr>
    <tr><td>功能概述</td><td>发布下肢关节控制指令</td></tr>
    <tr><td>参数说明</td><td>command：包含目标角度/速度等控制信息的下肢关节控制指令</td></tr>
    <tr><td>返回值</td><td><code>Status::OK</code> 表示成功，其他为失败。</td></tr>
    <tr><td>备注</td><td>非阻塞接口。</td></tr>
  </tbody>
</table>

### EnableSendMsg
<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>项目</strong></th>
      <th style="width: 60%; text-align: center;"><strong>内容</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td>函数名</td><td>EnableSendMsg</td></tr>
    <tr><td>函数声明</td><td><code>void EnableSendMsg(bool enable);</code></td></tr>
    <tr><td>功能概述</td><td>LCM 通道开关</td></tr>
    <tr><td>参数说明</td><td>enable：LCM 通道开关信息</td></tr>
    <tr><td>备注</td><td>使用高层运动控制时，关闭 LCM 通道，使用底层运动控制时，打开 LCM 通道。</td></tr>
  </tbody>
</table>

## 类型定义

### <code>SingleLegJointCommand</code> — 单个下肢关节的控制命令

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>q_des</code></td><td><code>float</code></td><td>期望关节位置</td></tr>
    <tr><td><code>dq_des</code></td><td><code>float</code></td><td>期望关节速度</td></tr>
    <tr><td><code>tau_des</code></td><td><code>float</code></td><td>期望前馈力矩</td></tr>
    <tr><td><code>kp</code></td><td><code>float</code></td><td>P 增益，必须为正数</td></tr>
    <tr><td><code>kd</code></td><td><code>float</code></td><td>D 增益，必须为正数</td></tr>
  </tbody>
</table>

---

### <code>LegJointCommand</code> — 整个下肢控制命令

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>timestamp</code></td><td><code>int64_t</code></td><td>时间戳（单位：纳秒）</td></tr>
    <tr><td><code>cmd</code></td><td><code>std::array&lt;SingleLegJointCommand, kLegJointNum&gt;</code></td><td>控制命令数组</td></tr>
  </tbody>
</table>

---

### <code>SingleLegJointState</code> — 单个下肢关节的状态

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>q</code></td><td><code>float</code></td><td>实际关节位置</td></tr>
    <tr><td><code>dq</code></td><td><code>float</code></td><td>实际关节速度</td></tr>
    <tr><td><code>tau_est</code></td><td><code>float</code></td><td>估计力矩</td></tr>
  </tbody>
</table>

---

### <code>LegState</code> — 整个下肢状态信息

<table style="width: 100%; table-layout: fixed; border-collapse: collapse; text-align: left;">
  <thead>
    <tr>
      <th style="width: 40%; text-align: center;"><strong>字段名</strong></th>
      <th style="width: 20%; text-align: center;"><strong>类型</strong></th>
      <th style="width: 40%; text-align: center;"><strong>描述</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr><td><code>timestamp</code></td><td><code>int64_t</code></td><td>时间戳（单位：纳秒）</td></tr>
    <tr><td><code>state</code></td><td><code>std::array&lt;SingleLegJointState, kLegJointNum&gt;</code></td><td>所有下肢关节状态</td></tr>
  </tbody>
</table>

## URDF 参考

[机器人 URDF](https://github.com/MagiclabRobotics/magicdog_description)


## 底层运动控制机器人状态介绍

机器人底层运动主要是开发关节的三环控制给开发人员进行机器人运动能力的二次开发，基本的控制状态切换机制：

![状态切换示意图](../image/dog/low_level_ctrl_state.png)

## 注意事项

在使用 Subscribe 等订阅类 SDK 接口时，请避免在回调函数中执行阻塞式的数据处理操作。否则，可能导致消息堆积、处理延迟，甚至引发不可预期的错误。